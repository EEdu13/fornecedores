<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fornecimento de Refei√ß√µes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Screen Styles */
        .login-container {
            max-width: 500px;
            margin: 10vh auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideInFromTop 0.6s ease;
        }

        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .login-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .login-form {
            padding: 40px 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        .supplier-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            border-left: 4px solid #3498db;
        }

        .supplier-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .supplier-info p {
            margin: 5px 0;
            color: #5a6c7d;
            font-size: 0.95rem;
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Main system hidden initially */
        .main-system {
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .period-info {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin: 20px 30px;
            border-radius: 8px;
        }

        .period-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .period-controls {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
        }

        .period-selectors {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .form-section {
            padding: 30px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin: 20px 0;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 1.1rem;
        }

        th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 18px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            position: sticky;
            left: 0;
            z-index: 20;
            min-width: 120px;
            max-width: 120px;
        }

        td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 1rem;
        }

        .date-cell {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 15;
            min-width: 120px;
            max-width: 120px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        .total-row {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .total-row td {
            border-bottom: none;
            padding: 20px 12px;
        }

        .total-row .date-cell {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        input[type="number"] {
            width: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background: #f8f9ff;
            transform: scale(1.02);
        }

        input[type="number"]:hover {
            border-color: #3498db;
        }

        .period-selectors select {
            padding: 8px; 
            border-radius: 5px; 
            border: 2px solid #3498db;
            font-size: 1rem;
            background: white;
        }

        .period-selectors select option:disabled {
            color: #ccc;
            background: #f5f5f5;
        }

        .period-blocked {
            background: #ffeaea !important;
            border-color: #e74c3c !important;
        }

        .actions {
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .summary {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 12px;
            display: none;
        }

        .summary h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .total-payment {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }

        .total-payment .amount {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .validation-section {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 40px;
            text-align: center;
            display: none;
        }

        .validation-section h3 {
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .camera-container {
            display: inline-block;
            position: relative;
            margin: 20px 0;
        }

        .camera-frame {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 5px solid #fff;
            overflow: hidden;
            position: relative;
            background: #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .camera-frame video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 0 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1 !important;
            max-width: 250px !important;
            max-height: 250px !important;
        }

        .camera-frame canvas,
        .camera-frame img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 0 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 2 !important;
            max-width: 250px !important;
            max-height: 250px !important;
        }

        .camera-placeholder {
            position: absolute;
            z-index: 0;
            color: white;
            text-align: center;
            font-size: 0.9rem;
        }

        .camera-frame.face-detected {
            border: 5px solid #27ae60;
            box-shadow: 0 0 30px rgba(39, 174, 96, 0.8);
            animation: pulse-green 2s infinite;
        }

        /* QR Code Interface Styles */
        .qr-code-interface {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            color: white;
        }

        .qr-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .qr-code-display {
            background: white;
            padding: 20px;
            border-radius: 15px;
            display: inline-block;
        }

        #qrCanvas {
            border-radius: 10px;
        }

        .qr-instructions {
            flex: 1;
            min-width: 300px;
        }

        .qr-instructions h4 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .qr-instructions p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .qr-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .qr-status.success {
            background: rgba(46, 204, 113, 0.3);
            border: 2px solid #2ecc71;
        }

        .qr-status.waiting {
            background: rgba(241, 196, 15, 0.3);
            border: 2px solid #f1c40f;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); }
            50% { box-shadow: 0 0 40px rgba(39, 174, 96, 1); }
            100% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                overflow-x: hidden;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header img {
                height: 40px;
            }
            
            .camera-frame {
                width: 200px;
                height: 200px;
                position: relative;
                overflow: hidden;
            }
            
            .camera-frame video {
                width: 200px !important;
                height: 200px !important;
                max-width: 200px !important;
                max-height: 200px !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                object-fit: cover !important;
                border-radius: 0 !important;
                transform: scaleX(-1) !important;
            }
            
            .camera-container {
                padding: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .validation-section {
                padding: 20px;
            }
            
            /* Prevent video from going fullscreen */
            video::-webkit-media-controls-fullscreen-button {
                display: none !important;
            }
            
            video::-webkit-media-controls {
                display: none !important;
            }
            
            .validation-section h3 {
                font-size: 1.3rem;
            }

            /* QR Code responsive styles */
            .qr-container {
                flex-direction: column;
                gap: 20px;
            }

            .qr-instructions {
                min-width: auto;
            }

            .qr-instructions h4 {
                font-size: 1.1rem;
            }

            .qr-instructions p {
                font-size: 1rem;
            }
            
            .validation-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .validation-actions button {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
            }
            
            .approach-text {
                font-size: 1rem;
                padding: 10px;
            }
            
            .signature-info {
                padding: 10px;
                font-size: 0.8rem;
            }
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            color: #bdc3c7;
            font-size: 1.2rem;
            text-align: center;
        }

        .approach-text {
            margin-top: 20px;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .validation-actions {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .step-indicator {
            background: #ecf0f1;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 8px;
            text-align: center;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .step {
            flex: 1;
            min-width: 150px;
            padding: 15px 10px;
            border-radius: 8px;
            font-weight: 600;
            position: relative;
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        .step.active {
            background: #3498db;
            color: white;
        }

        .step.pending {
            background: #bdc3c7;
            color: #7f8c8d;
        }

        .signature-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            max-height: 65vh;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            position: relative;
            top: -20px;
            overflow-y: auto;
        }

        /* Mobile adjustments for modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 2% auto;
                max-height: 90vh;
                top: 0;
            }
            
            .modal-header {
                padding: 10px 15px;
            }
            
            .modal-header h2 {
                font-size: 1.2rem;
                margin: 0;
            }
            
            .modal-body {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            .calculation-item {
                padding: 8px;
                margin: 5px 0;
            }
            
            .calculation-item h4 {
                font-size: 1rem;
                margin-bottom: 5px;
            }
            
            .modal-actions {
                padding: 15px;
                gap: 10px;
            }
            
            .modal-actions button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-body {
            padding: 20px 30px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover,
        .close:focus {
            color: white;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .preview-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: transform 0.3s ease;
        }

        .preview-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .preview-item .label {
            color: #495057;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .preview-item .quantity {
            font-size: 1.5rem;
            color: #3498db;
            font-weight: bold;
            margin: 3px 0;
        }

        .preview-item .value {
            font-size: 1rem;
            color: #27ae60;
            font-weight: 600;
        }

        .preview-total {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
        }

        .preview-total .total-label {
            font-size: 1rem;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .preview-total .total-amount {
            font-size: 2rem;
            font-weight: bold;
        }

        .modal-actions {
            padding: 15px 30px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.6rem;
                line-height: 1.2;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .period-info {
                margin: 15px 20px;
                padding: 15px;
            }
            
            .period-info h3 {
                font-size: 1.2rem;
            }
            
            .period-controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .period-selectors {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .table-container {
                margin: 15px 0;
                border-radius: 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                font-size: 1rem;
                min-width: 700px;
            }
            
            th {
                padding: 15px 10px;
                font-size: 0.9rem;
            }
            
            th:first-child {
                min-width: 100px;
                max-width: 100px;
            }
            
            td {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
            
            .date-cell {
                min-width: 100px;
                max-width: 100px;
                font-size: 0.85rem;
            }
            
            input[type="number"] {
                width: 70px;
                padding: 8px;
                font-size: 1rem;
            }
            
            .total-row td {
                padding: 15px 8px;
                font-size: 1rem;
            }
            
            .actions, .validation-actions {
                flex-direction: column;
                align-items: center;
                padding: 20px 15px;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
                padding: 15px 25px;
                font-size: 1rem;
            }
            
            .camera-frame {
                width: 200px;
                height: 200px;
            }

            .steps {
                flex-direction: column;
                gap: 10px;
            }

            .step {
                min-width: auto;
                width: 100%;
                padding: 12px;
                font-size: 0.9rem;
            }

            .modal-content {
                width: 95%;
                margin: 3% auto;
                max-height: 85vh;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
            
            .modal-body {
                padding: 15px 20px;
            }

            .preview-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .preview-item {
                padding: 10px;
            }
            
            .preview-item .label {
                font-size: 0.8rem;
            }

            .preview-item .quantity {
                font-size: 1.2rem;
            }
            
            .preview-item .value {
                font-size: 0.9rem;
            }

            .preview-total .total-amount {
                font-size: 1.5rem;
            }
            
            .modal-actions {
                padding: 15px 20px;
            }
            
            .summary {
                margin: 15px 0;
                padding: 25px 20px;
            }
            
            .summary h3 {
                font-size: 1.3rem;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .summary-item {
                padding: 12px;
            }
            
            .summary-item .label {
                font-size: 0.85rem;
            }
            
            .summary-item .value {
                font-size: 1.1rem;
            }
            
            .total-payment .amount {
                font-size: 1.8rem;
            }
            
            .validation-section {
                padding: 30px 20px;
            }
            
            .validation-section h3 {
                font-size: 1.5rem;
            }
            
            .signature-info {
                padding: 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.4rem;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .period-info {
                margin: 10px 15px;
            }
            
            .step-indicator {
                margin: 15px 20px;
                padding: 15px;
            }
            
            table {
                min-width: 600px;
                font-size: 0.9rem;
            }
            
            th, td {
                font-size: 0.8rem;
            }
            
            th:first-child {
                min-width: 80px;
                max-width: 80px;
            }
            
            .date-cell {
                font-size: 0.75rem;
                min-width: 80px;
                max-width: 80px;
            }
            
            input[type="number"] {
                width: 60px;
                font-size: 0.9rem;
                padding: 6px;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 12px 20px;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 98%;
                margin: 1% auto;
            }
        }

        /* Custom popup modal styles */
        .custom-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .custom-popup.show {
            display: flex;
        }

        .popup-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .custom-popup.show .popup-content {
            transform: scale(1);
        }

        .popup-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .popup-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
            margin-bottom: 25px;
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .popup-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .popup-btn-yes {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .popup-btn-yes:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-2px);
        }

        .popup-btn-no {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .popup-btn-no:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
        }

        .popup-btn-ok {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .popup-btn-ok:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-2px);
        }

        @media (max-width: 480px) {
            .popup-content {
                padding: 20px;
                width: 95%;
            }
            
            .popup-buttons {
                flex-direction: column;
            }
            
            .popup-btn {
                width: 100%;
            }
        }

        /* PDF Loading Overlay */
        .pdf-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }

        .pdf-loading-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            width: 90%;
        }

        .pdf-loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pdf-loading-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .pdf-loading-message {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .pdf-loading-progress {
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .pdf-loading-progress-bar {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pdf-loading-steps {
            text-align: left;
            font-size: 12px;
            color: #95a5a6;
        }

        .pdf-loading-step {
            margin: 5px 0;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .pdf-loading-step.active {
            opacity: 1;
            color: #e74c3c;
            font-weight: bold;
        }

        .pdf-loading-step.completed {
            opacity: 1;
            color: #27ae60;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .pdf-loading-container {
                padding: 30px 20px;
                max-width: 300px;
            }
            
            .pdf-loading-spinner {
                width: 50px;
                height: 50px;
                border-width: 5px;
            }
            
            .pdf-loading-title {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <img src="LARSIL_branco_fundo_transparente.png" alt="LARSIL" style="height: 80px; width: auto; margin-bottom: 20px;">
            <h1>üçΩÔ∏è Sistema Refei√ß√µes</h1>
            <p>Acesso para Fornecedores</p>
        </div>
        <div class="login-form">
            <form id="loginForm">
                <div class="form-group">
                    <label for="supplierSelect">Selecione sua empresa:</label>
                    <select id="supplierSelect" name="supplier" style="width: 100%;">
                        <option value="">Carregando fornecedores...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="supplierPassword">Senha:</label>
                    <input type="password" id="supplierPassword" name="password" placeholder="Digite sua senha" disabled>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn" disabled>
                    Acessar Sistema
                </button>
            </form>
        </div>
    </div>

    <!-- Main System (hidden initially) -->
    <div id="mainSystem" class="main-system">
        <div class="container">
            <div class="header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <img src="LARSIL_branco_fundo_transparente.png" alt="LARSIL" style="height: 60px; width: auto;">
                        <div>
                            <h1 id="systemTitle" style="margin: 0;">Sistema de Fornecimento de Refei√ß√µes</h1>
                            <p id="welcomeMessage" style="margin: 5px 0 0 0;">Coleta Quinzenal - Fornecedores</p>
                        </div>
                    </div>
                    <button onclick="logout()" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Sair
                    </button>
                </div>
            </div>

        <div class="step-indicator">
            <div class="steps">
                <div class="step completed" id="step1">1. Preenchimento</div>
                <div class="step pending" id="step2">2. Resumo</div>
                <div class="step pending" id="step3">3. Valida√ß√£o Facial</div>
                <div class="step pending" id="step4">4. PDF Gerado</div>
            </div>
        </div>

        <div class="period-info">
            <h3>üìÖ Per√≠odo de Fornecimento</h3>
            <div class="period-controls">
                <div class="period-selectors">
                    <div>
                        <label for="monthSelect" style="font-weight: 600; margin-right: 10px;">M√™s:</label>
                        <select id="monthSelect" onchange="updatePeriod()" style="padding: 8px; border-radius: 5px; border: 2px solid #3498db;">
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08" selected>Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div>
                        <label for="quinzenaSelect" style="font-weight: 600; margin-right: 10px;">Quinzena:</label>
                        <select id="quinzenaSelect" onchange="updatePeriod()" style="padding: 8px; border-radius: 5px; border: 2px solid #3498db;">
                            <option value="1">1¬™ Quinzena</option>
                            <option value="2">2¬™ Quinzena</option>
                        </select>
                    </div>
                </div>
            </div>
            <p id="periodText"><strong>1¬™ Quinzena de Agosto/2025</strong> - 01/08/2025 √† 15/08/2025</p>
            <p>Preencha as quantidades necess√°rias para cada tipo de refei√ß√£o por data.</p>
        </div>

        <div class="form-section" id="formSection">
            <div class="table-container">
                <table id="mealsTable">
                    <thead>
                        <tr>
                            <th>DATA</th>
                            <th>CAF√â</th>
                            <th>ALM.<br>MARM.</th>
                            <th>ALM.<br>LOCAL</th>
                            <th>JANTA<br>MARM.</th>
                            <th>JANTA<br>LOCAL</th>
                            <th>GELO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="actions" id="initialActions">
            <button class="btn btn-primary" onclick="showCalculationPreview()">üìä Calcular Totais</button>
            <button class="btn btn-success" onclick="generateSummary()">üìã Finalizar Pedido</button>
        </div>

        <div id="summary" class="summary">
            <h3>üìä Resumo do Pedido</h3>
            <div class="summary-grid" id="summaryGrid">
                <!-- Summary items will be generated by JavaScript -->
            </div>
            <div class="total-payment">
                <div class="label">üí∞ VALOR TOTAL A RECEBER</div>
                <div class="amount" id="totalAmount">R$ 0,00</div>
            </div>
            <div class="actions" style="background: transparent; padding: 20px 0;">
                <button id="validationBtn" class="btn btn-warning" onclick="startValidation()">üì∏ Iniciar Valida√ß√£o Facial</button>
            </div>
        </div>

        <div id="validationSection" class="validation-section">
            <h3>üì∏ Valida√ß√£o Facial - Assinatura Digital</h3>
            <p>Posicione seu rosto no centro da c√¢mera para validar o pedido</p>
            
            <!-- QR Code Interface (for desktop without camera) -->
            <div id="qrCodeInterface" class="qr-code-interface" style="display: none;">
                <div class="qr-container">
                    <div class="qr-code-display">
                        <canvas id="qrCanvas"></canvas>
                    </div>
                    <div class="qr-instructions">
                        <h4>üì± Use seu celular para tirar a selfie</h4>
                        <p>1. Escaneie o QR Code com seu celular</p>
                        <p>2. Tire a selfie na tela que abrir</p>
                        <p>3. Aguarde... Detectaremos automaticamente!</p>
                        
                        <div class="qr-manual-link" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                            <strong>Link alternativo:</strong><br>
                            <span id="qrManualLink" style="word-break: break-all; color: #007bff; cursor: pointer;" 
                                  onclick="navigator.clipboard.writeText(this.textContent); alert('Link copiado!');">
                                Carregando...
                            </span>
                        </div>
                        
                        <div class="qr-status" id="qrStatus">
                            ‚è≥ Aguardando captura no celular...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="camera-container">
                <div class="camera-frame">
                    <video id="video" autoplay playsinline webkit-playsinline muted style="display: none;"></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <img id="capturedImage" style="display: none;" />
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        üì∑<br>
                        Clique em "Ativar C√¢mera"<br>
                        para come√ßar
                    </div>
                </div>
            </div>
            
            <div class="approach-text" id="approachText" style="display: none;">
                ÔøΩ Detectando rosto... Posicione-se na frente da c√¢mera
            </div>

            <div class="signature-info">
                <p><strong>üìã Informa√ß√µes da Assinatura Digital:</strong></p>
                <p>Data e Hora: <span id="signatureDateTime"></span></p>
                <p>Local: <span id="signatureLocation">Curitiba, Paran√°, BR</span></p>
            </div>

            <div class="validation-actions">
                <button class="btn btn-primary" id="activateCamera" onclick="activateCamera()">üìπ Ativar C√¢mera</button>
                <button class="btn btn-warning" id="generatePdfBtn" onclick="generatePDF()" style="display: none;">üìÑ Gerar PDF e Baixar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Preview dos C√°lculos -->
    <div id="calculationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeCalculationModal()">&times;</span>
                <h3>üìä Resumo dos Totais Calculados</h3>
            </div>
            <div class="modal-body">
                <div class="preview-grid" id="previewGrid">
                    <!-- Preview items will be generated by JavaScript -->
                </div>
                <div class="preview-total">
                    <div class="total-label">üí∞ VALOR TOTAL ESTIMADO</div>
                    <div class="total-amount" id="previewTotalAmount">R$ 0,00</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="proceedToSummary()">‚úÖ Confirmar e Finalizar Pedido</button>
                <button class="btn btn-primary" onclick="closeCalculationModal()">‚úèÔ∏è Continuar Editando</button>
            </div>
        </div>
    </div>

    <!-- Custom popup modal -->
    <div id="customPopup" class="custom-popup">
        <div class="popup-content">
            <div id="popupTitle" class="popup-title"></div>
            <div id="popupMessage" class="popup-message"></div>
            <div id="popupButtons" class="popup-buttons"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script>
        // Global variables
        let capturedPhoto = null;
        let stream = null;
        let currentDates = [];
        let currentSupplier = null;
        let suppliers = []; // Array to store suppliers from Excel
        
        // QR Code system variables
        let currentSession = null;
        let qrPollingInterval = null;
        let isQRCaptureMode = false;

        // Device and camera detection functions
        function isMobileDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
            return mobileRegex.test(userAgent) || window.innerWidth <= 768;
        }

        async function isCameraAvailable() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                return devices.some(device => device.kind === 'videoinput');
            } catch (error) {
                console.warn('Could not check camera availability:', error);
                return false;
            }
        }

        // Session management functions
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveSession(sessionId) {
            const sessionData = {
                id: sessionId,
                timestamp: Date.now(),
                supplier: currentSupplier ? currentSupplier.fornecedor : 'Unknown'
            };
            sessionStorage.setItem('qr_session', JSON.stringify(sessionData));
        }

        function getSession() {
            const sessionData = sessionStorage.getItem('qr_session');
            if (!sessionData) return null;
            
            try {
                const session = JSON.parse(sessionData);
                // Check if session is expired (10 minutes)
                if (Date.now() - session.timestamp > 10 * 60 * 1000) {
                    sessionStorage.removeItem('qr_session');
                    return null;
                }
                return session;
            } catch (error) {
                sessionStorage.removeItem('qr_session');
                return null;
            }
        }

        function cleanupSession(sessionId) {
            sessionStorage.removeItem('qr_session');
            localStorage.removeItem(`photo_${sessionId}`);
        }

        // Check if this is QR capture mode
        function checkQRCaptureMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const sessionId = urlParams.get('session');
            
            if (mode === 'capture' && sessionId) {
                isQRCaptureMode = true;
                currentSession = sessionId;
                setupQRCaptureInterface();
                return true;
            }
            return false;
        }

        // Setup simplified interface for QR capture
        function setupQRCaptureInterface() {
            // Hide all sections except validation
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            
            // Hide everything except validation section
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.step-indicator').style.display = 'none';
            document.querySelector('.period-info').style.display = 'none';
            document.querySelector('.form-section').style.display = 'none';
            document.querySelector('#initialActions').style.display = 'none';
            document.querySelector('#summary').style.display = 'none';
            
            // Show only validation section
            document.getElementById('validationSection').style.display = 'block';
            
            // Update title
            document.querySelector('#validationSection h3').innerHTML = 'üì± Captura de Selfie';
            document.querySelector('#validationSection p').innerHTML = 'Tire sua selfie para validar o pedido no sistema principal';
            
            // Auto-activate camera
            setTimeout(() => {
                activateCamera();
            }, 1000);
        }

        // Function to determine prices based on supplier data from Excel
        function getPricesFromExcelData(supplierRows, indexes) {
            // Helper function to parse value
            function parseValue(value) {
                if (!value) return 0;
                if (typeof value === 'number') return value;
                if (typeof value === 'string') {
                    // Handle Brazilian format: "10,49" or "R$ 10,49"
                    return parseFloat(value.replace(/[R$\s]/g, '').replace(',', '.')) || 0;
                }
                return 0;
            }
            
            // Initialize prices with zeros
            const prices = {
                cafe: 0,
                almocoMarmitex: 0,
                almocoLocal: 0,
                jantaMarmitex: 0,
                jantaLocal: 0,
                gelo: 0
            };
            
            // Process all rows for this supplier to extract pricing based on TIPO_FORN
            supplierRows.forEach(row => {
                const tipo_forn = row[indexes.tipo];
                const valor = parseValue(row[indexes.valorGeral]);
                
                if (tipo_forn && valor > 0) {
                    const tipoUpper = tipo_forn.toString().toUpperCase();
                    
                    if (tipoUpper.includes('CAF√â') || tipoUpper.includes('CAFE')) {
                        prices.cafe = valor;
                    } else if (tipoUpper.includes('ALMO√áO') && tipoUpper.includes('MARMITEX')) {
                        prices.almocoMarmitex = valor;
                    } else if (tipoUpper.includes('ALMO√áO') && tipoUpper.includes('LOCAL')) {
                        prices.almocoLocal = valor;
                    } else if (tipoUpper.includes('JANTA') && tipoUpper.includes('MARMITEX')) {
                        prices.jantaMarmitex = valor;
                    } else if (tipoUpper.includes('JANTA') && tipoUpper.includes('LOCAL')) {
                        prices.jantaLocal = valor;
                    } else if (tipoUpper.includes('GELO')) {
                        prices.gelo = valor;
                    } else if (tipoUpper.includes('ALMO√áO')) {
                        // Default to marmitex if not specified
                        prices.almocoMarmitex = valor;
                    }
                }
            });
            
            return prices;
        }

        // Function to format currency in Brazilian format
        function formatCurrency(value) {
            if (typeof value !== 'number') {
                value = parseFloat(value) || 0;
            }
            
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Check for auto-login after page reload
        function checkAutoLogin() {
            const autoLoginData = localStorage.getItem('autoLogin');
            if (autoLoginData) {
                try {
                    const data = JSON.parse(autoLoginData);
                    const timeDiff = Date.now() - data.timestamp;
                    
                    // Auto-login is valid for 5 minutes
                    if (timeDiff < 5 * 60 * 1000 && suppliers[data.supplierIndex]) {
                        // Select the supplier
                        $('#supplierSelect').val(data.supplierIndex).trigger('change');
                        
                        // Set current supplier
                        currentSupplier = suppliers[data.supplierIndex];
                        
                        // Update system prices with real supplier data
                        prices = currentSupplier.prices;
                        
                        // Auto-login (skip password check after reset)
                        setTimeout(() => {
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainSystem').style.display = 'block';
                            
                            // Update welcome message with supplier info
                            document.getElementById('welcomeMessage').innerHTML = `Bem-vindo, <strong>${currentSupplier.fornecedor}</strong> | CNPJ: ${currentSupplier.cpf_cnpj}`;
                            
                            // Initialize the system
                            updatePeriod();
                            
                            // Show success message
                            showCustomAlert(
                                'üîÑ Sess√£o Restaurada!',
                                `Bem-vindo de volta, <strong>${currentSupplier.fornecedor}</strong>!<br><br>Formul√°rio resetado para novo pedido.`,
                                () => {} // onOk - do nothing
                            );
                            
                            // Clear auto-login data after successful use
                            localStorage.removeItem('autoLogin');
                        }, 1000);
                        
                        return true;
                    } else {
                        // Clear expired auto-login data
                        localStorage.removeItem('autoLogin');
                    }
                } catch (error) {
                    console.error('Erro ao processar auto-login:', error);
                    localStorage.removeItem('autoLogin');
                }
            }
            return false;
        }

        // Custom popup functions
        function showCustomConfirm(title, message, onYes, onNo) {
            const popup = document.getElementById('customPopup');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            const buttonsEl = document.getElementById('popupButtons');

            titleEl.textContent = title;
            messageEl.innerHTML = message;
            
            buttonsEl.innerHTML = `
                <button class="popup-btn popup-btn-yes" onclick="handlePopupYes()">‚úÖ Sim - Novo pedido</button>
                <button class="popup-btn popup-btn-no" onclick="handlePopupNo()">‚ùå N√£o - Manter dados</button>
            `;

            // Store callbacks globally for onclick handlers
            window.popupYesCallback = onYes;
            window.popupNoCallback = onNo;

            popup.classList.add('show');
        }

        function showCustomAlert(title, message, onOk) {
            const popup = document.getElementById('customPopup');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            const buttonsEl = document.getElementById('popupButtons');

            titleEl.textContent = title;
            messageEl.innerHTML = message;
            
            buttonsEl.innerHTML = `
                <button class="popup-btn popup-btn-ok" onclick="handlePopupOk()">üìù Entendi</button>
            `;

            // Store callback globally for onclick handler
            window.popupOkCallback = onOk;

            popup.classList.add('show');
        }

        function hideCustomPopup() {
            const popup = document.getElementById('customPopup');
            popup.classList.remove('show');
        }

        function handlePopupYes() {
            hideCustomPopup();
            if (window.popupYesCallback) {
                window.popupYesCallback();
            }
        }

        function handlePopupNo() {
            hideCustomPopup();
            if (window.popupNoCallback) {
                window.popupNoCallback();
            }
        }

        function handlePopupOk() {
            hideCustomPopup();
            if (window.popupOkCallback) {
                window.popupOkCallback();
            }
        }

        // Function to initialize supplier select dropdown
        function initializeSupplierSelect() {
            const select = $('#supplierSelect');
            select.empty();
            select.append('<option value="">Selecione sua empresa...</option>');
            
            suppliers.forEach((supplier, index) => {
                select.append(`<option value="${index}">${supplier.fornecedor}</option>`);
            });
            
            // Initialize Select2
            select.select2({
                placeholder: 'Digite ou selecione sua empresa...',
                allowClear: true,
                width: '100%'
            });
            
            // Handle selection change
            select.on('change', function() {
                const selectedValue = $(this).val();
                const loginBtn = document.getElementById('loginBtn');
                
                if (selectedValue) {
                    loginBtn.disabled = false;
                    currentSupplier = suppliers[selectedValue];
                } else {
                    loginBtn.disabled = true;
                    currentSupplier = null;
                }
            });
        }

        // Function to handle login
        function login(event) {
            event.preventDefault();
            
            if (!currentSupplier) {
                showCustomAlert(
                    '‚ùå Erro',
                    'Selecione um fornecedor antes de fazer login.',
                    () => {}
                );
                return;
            }
            
            // Update system prices with real supplier data
            prices = currentSupplier.prices;
            
            // Hide login screen and show main system
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            
            // Update welcome message with supplier info
            document.getElementById('welcomeMessage').innerHTML = `Bem-vindo, <strong>${currentSupplier.fornecedor}</strong> | CNPJ: ${currentSupplier.cpf_cnpj}`;
            
            // Initialize the system
            updatePeriod();
        }

        // Function to logout
        function logout() {
            showCustomConfirm(
                'üö™ Sair do Sistema',
                'Tem certeza que deseja sair?<br><br>Todos os dados n√£o salvos ser√£o perdidos.',
                () => {
                    // onYes - complete logout
                    currentSupplier = null;
                    if (typeof $ !== 'undefined' && $('#supplierSelect').length) {
                        $('#supplierSelect').val('').trigger('change');
                    }
                    document.getElementById('supplierPassword').value = '';
                    document.getElementById('supplierPassword').disabled = true;
                    document.getElementById('supplierInfo').style.display = 'none';
                    document.getElementById('loginBtn').disabled = true;
                    document.getElementById('loginScreen').style.display = 'block';
                    document.getElementById('mainSystem').style.display = 'none';
                    
                    // Clear any form data
                    const inputs = document.querySelectorAll('#mealsTable input');
                    inputs.forEach(input => input.value = '');
                    
                    // Hide validation section
                    document.getElementById('validationSection').style.display = 'none';
                    
                    // Reset steps
                    document.querySelectorAll('.step').forEach(step => {
                        step.className = 'step pending';
                    });
                },
                () => {} // onNo - do nothing
            );
        }

        // Function to load suppliers from SQL Server Azure API
        async function loadSuppliersFromAPI() {
            try {
                const response = await fetch('http://localhost:8000/api/suppliers');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const suppliersData = await response.json();
                
                // Convert API data to the expected format
                suppliers = suppliersData.map(supplier => ({
                    fornecedor: supplier.fornecedor || 'N/A',
                    cpf_cnpj: supplier.cpf_cnpj || 'N/A',
                    tipo_forn: 'Alimenta√ß√£o',
                    projeto: 'LARSIL',
                    local: 'N/A',
                    prices: {
                        cafe: supplier.cafe || 0,
                        almocoMarmitex: supplier.almoco_marmitex || 0,
                        almocoLocal: supplier.almoco_local || 0,
                        jantaMarmitex: supplier.janta_marmitex || 0,
                        jantaLocal: supplier.janta_local || 0,
                        gelo: supplier.gelo || 0
                    }
                }));

                // Initialize the select after loading data
                initializeSupplierSelect();
                
                // Check for auto-login after suppliers are loaded
                checkAutoLogin();
                
            } catch (error) {
                // Fallback to Excel if API fails
                try {
                    await loadSuppliersFromExcel();
                } catch (excelError) {
                    console.error('‚ùå Erro no fallback Excel:', excelError);
                    // Show error message
                    showCustomAlert(
                        '‚ùå Erro ao Carregar Dados',
                        'N√£o foi poss√≠vel carregar dados nem da API nem do arquivo Excel.<br><br>Verifique se o servidor est√° rodando ou se o arquivo Results.xlsx est√° presente.',
                        () => {}
                    );
                    suppliers = [];
                    initializeSupplierSelect();
                }
            }
        }

        // Function to load suppliers from Excel file (fallback)
        async function loadSuppliersFromExcel() {
            try {
                const response = await fetch('Results.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Assume data is in the first sheet
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Find header row and extract suppliers
                const headers = jsonData[0]; // First row should be headers
                const fornecedorIndex = headers.findIndex(h => h && h.toString().toUpperCase().includes('FORNECEDOR'));
                const cnpjIndex = headers.findIndex(h => h && h.toString().toUpperCase().includes('CPF_CNPJ'));
                const tipoIndex = headers.findIndex(h => h && h.toString().toUpperCase().includes('TIPO_FORN'));
                const projetoIndex = headers.findIndex(h => h && h.toString().toUpperCase().includes('PROJETO'));
                const localIndex = headers.findIndex(h => h && h.toString().toUpperCase().includes('LOCAL'));
                
                // Find the general VALOR column (this is the main one in your Excel)
                const valorGeralIndex = headers.findIndex(h => h && h.toString().toUpperCase().includes('VALOR'));
                
                // Create indexes object for easy access
                const indexes = {
                    fornecedor: fornecedorIndex,
                    cnpj: cnpjIndex,
                    tipo: tipoIndex,
                    projeto: projetoIndex,
                    local: localIndex,
                    valorGeral: valorGeralIndex
                };
                
                // Extract suppliers and group by fornecedor
                const suppliersMap = new Map();
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row[fornecedorIndex]) {
                        const fornecedor = row[fornecedorIndex].toString().trim();
                        
                        if (!suppliersMap.has(fornecedor)) {
                            suppliersMap.set(fornecedor, []);
                        }
                        
                        suppliersMap.get(fornecedor).push(row);
                    }
                }
                
                // Convert to suppliers array with aggregated pricing
                const suppliersData = [];
                
                suppliersMap.forEach((rows, fornecedor) => {
                    // Use the first row for basic info
                    const firstRow = rows[0];
                    
                    suppliersData.push({
                        fornecedor: fornecedor,
                        cpf_cnpj: firstRow[cnpjIndex] || 'N/A',
                        tipo_forn: 'Alimenta√ß√£o', // General type
                        projeto: firstRow[projetoIndex] || 'LARSIL',
                        local: firstRow[localIndex] || 'N/A',
                        prices: getPricesFromExcelData(rows, indexes) // Pass all rows for this supplier
                    });
                });
                
                suppliers = suppliersData;
                
                // Initialize the select after loading data
                initializeSupplierSelect();
                
                // Check for auto-login after suppliers are loaded
                checkAutoLogin();
                
            } catch (error) {
                console.error('Error loading Excel file:', error);
                throw error; // Re-throw for parent handler
            }
        }

        // Current prices (will be set after login with real supplier data)
        let prices = {
            cafe: 0,
            almocoMarmitex: 0,
            almocoLocal: 0,
            jantaMarmitex: 0,
            jantaLocal: 0,
            gelo: 0
        };

        // Month names
        const monthNames = {
            '01': 'Janeiro', '02': 'Fevereiro', '03': 'Mar√ßo', '04': 'Abril',
            '05': 'Maio', '06': 'Junho', '07': 'Julho', '08': 'Agosto',
            '09': 'Setembro', '10': 'Outubro', '11': 'Novembro', '12': 'Dezembro'
        };

        // Days in month
        const daysInMonth = {
            '01': 31, '02': 28, '03': 31, '04': 30, '05': 31, '06': 30,
            '07': 31, '08': 31, '09': 30, '10': 31, '11': 30, '12': 31
        };

        function generateDatesForPeriod(month, quinzena) {
            const year = 2025;
            const totalDays = daysInMonth[month];
            const dates = [];
            
            if (quinzena === '1') {
                // 1¬™ quinzena: dia 1 ao 15
                for (let day = 1; day <= 15; day++) {
                    dates.push(`${day.toString().padStart(2, '0')}/${month}`);
                }
            } else {
                // 2¬™ quinzena: dia 16 ao √∫ltimo dia do m√™s
                for (let day = 16; day <= totalDays; day++) {
                    dates.push(`${day.toString().padStart(2, '0')}/${month}`);
                }
            }
            
            return dates;
        }

        function updatePeriod() {
            const month = document.getElementById('monthSelect').value;
            const quinzena = document.getElementById('quinzenaSelect').value;
            const monthName = monthNames[month];
            
            // Permitir qualquer per√≠odo (incluindo retroativos)
            currentDates = generateDatesForPeriod(month, quinzena);
            
            const startDate = currentDates[0];
            const endDate = currentDates[currentDates.length - 1];
            
            // Verificar se √© per√≠odo retroativo para mostrar aviso
            const isRetroactive = isPeriodInPast(month, quinzena);
            
            if (isRetroactive) {
                document.getElementById('periodText').innerHTML = 
                    `<strong>${quinzena}¬™ Quinzena de ${monthName}/2025</strong> - ${startDate} √† ${endDate}<br>
                     <span style="color: #f39c12; font-weight: bold;">‚ö†Ô∏è PER√çODO RETROATIVO</span>
                     <small style="color: #7f8c8d; display: block;">Este per√≠odo j√° passou, mas voc√™ pode fazer o pedido normalmente.</small>`;
            } else {
                document.getElementById('periodText').innerHTML = 
                    `<strong>${quinzena}¬™ Quinzena de ${monthName}/2025</strong> - ${startDate} √† ${endDate}`;
            }
            
            generateTable();
            calculateTotals();
        }

        function isPeriodInPast(month, quinzena) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() returns 0-11
            const currentDay = currentDate.getDate();
            
            const selectedMonth = parseInt(month);
            const selectedQuinzena = parseInt(quinzena);
            
            // If year is past, it's retroactive
            if (currentYear > 2025) {
                return true;
            }
            
            // If year is future, it's not retroactive
            if (currentYear < 2025) {
                return false;
            }
            
            // Same year (2025), check month and quinzena
            if (selectedMonth < currentMonth) {
                return true; // Past month - retroactive
            }
            
            if (selectedMonth > currentMonth) {
                return false; // Future month - not retroactive
            }
            
            // Same month, check quinzena
            if (selectedMonth === currentMonth) {
                if (selectedQuinzena === 1 && currentDay > 15) {
                    return true; // First quinzena already passed - retroactive
                }
                if (selectedQuinzena === 2 && currentDay > 31) {
                    return true; // Second quinzena already passed - retroactive
                }
            }
            
            return false; // Current or future period
        }

        // Generate table rows
        function generateTable() {
            const tbody = document.querySelector('#mealsTable tbody');
            tbody.innerHTML = ''; // Clear existing rows
            
            currentDates.forEach((date, rowIndex) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="date-cell">${date}</td>
                    <td><input type="number" min="0" value="" onchange="calculateTotals();" placeholder="0" data-row="${rowIndex}" data-col="0"></td>
                    <td><input type="number" min="0" value="" onchange="calculateTotals();" placeholder="0" data-row="${rowIndex}" data-col="1"></td>
                    <td><input type="number" min="0" value="" onchange="calculateTotals();" placeholder="0" data-row="${rowIndex}" data-col="2"></td>
                    <td><input type="number" min="0" value="" onchange="calculateTotals();" placeholder="0" data-row="${rowIndex}" data-col="3"></td>
                    <td><input type="number" min="0" value="" onchange="calculateTotals();" placeholder="0" data-row="${rowIndex}" data-col="4"></td>
                    <td><input type="number" min="0" value="" onchange="calculateTotals();" placeholder="0" data-row="${rowIndex}" data-col="5"></td>
                `;
                tbody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td class="date-cell">TOTAL</td>
                <td id="totalCafe">0</td>
                <td id="totalAlmocoMarmitex">0</td>
                <td id="totalAlmocoLocal">0</td>
                <td id="totalJantaMarmitex">0</td>
                <td id="totalJantaLocal">0</td>
                <td id="totalGelo">0</td>
            `;
            tbody.appendChild(totalRow);
            
            // Add navigation functionality
            addTableNavigation();
        }

        function addTableNavigation() {
            const inputs = document.querySelectorAll('#mealsTable tbody input[type="number"]');
            
            inputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    const currentRow = parseInt(this.dataset.row);
                    const currentCol = parseInt(this.dataset.col);
                    const totalRows = currentDates.length;
                    const totalCols = 6;
                    
                    let nextInput = null;
                    
                    switch(e.key) {
                        case 'Enter':
                            e.preventDefault();
                            // Move to next row, same column
                            if (currentRow < totalRows - 1) {
                                nextInput = document.querySelector(`input[data-row="${currentRow + 1}"][data-col="${currentCol}"]`);
                            } else {
                                // If last row, move to first row, next column
                                if (currentCol < totalCols - 1) {
                                    nextInput = document.querySelector(`input[data-row="0"][data-col="${currentCol + 1}"]`);
                                } else {
                                    // If last cell, go to first cell
                                    nextInput = document.querySelector(`input[data-row="0"][data-col="0"]`);
                                }
                            }
                            break;
                            
                        case 'ArrowDown':
                            e.preventDefault();
                            if (currentRow < totalRows - 1) {
                                nextInput = document.querySelector(`input[data-row="${currentRow + 1}"][data-col="${currentCol}"]`);
                            }
                            break;
                            
                        case 'ArrowUp':
                            e.preventDefault();
                            if (currentRow > 0) {
                                nextInput = document.querySelector(`input[data-row="${currentRow - 1}"][data-col="${currentCol}"]`);
                            }
                            break;
                            
                        case 'ArrowRight':
                        case 'Tab':
                            if (e.key === 'Tab') e.preventDefault();
                            if (currentCol < totalCols - 1) {
                                nextInput = document.querySelector(`input[data-row="${currentRow}"][data-col="${currentCol + 1}"]`);
                            } else if (currentRow < totalRows - 1) {
                                // Move to next row, first column
                                nextInput = document.querySelector(`input[data-row="${currentRow + 1}"][data-col="0"]`);
                            }
                            break;
                            
                        case 'ArrowLeft':
                            e.preventDefault();
                            if (currentCol > 0) {
                                nextInput = document.querySelector(`input[data-row="${currentRow}"][data-col="${currentCol - 1}"]`);
                            } else if (currentRow > 0) {
                                // Move to previous row, last column
                                nextInput = document.querySelector(`input[data-row="${currentRow - 1}"][data-col="${totalCols - 1}"]`);
                            }
                            break;
                    }
                    
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select(); // Select all text for easy replacement
                    }
                });
            });
        }

        function calculateTotals() {
            const inputs = document.querySelectorAll('#mealsTable tbody tr:not(.total-row) input');
            const totals = [0, 0, 0, 0, 0, 0];

            for (let i = 0; i < inputs.length; i++) {
                const columnIndex = i % 6;
                totals[columnIndex] += parseInt(inputs[i].value) || 0;
            }

            // Update totals
            document.getElementById('totalCafe').textContent = totals[0];
            document.getElementById('totalAlmocoMarmitex').textContent = totals[1];
            document.getElementById('totalAlmocoLocal').textContent = totals[2];
            document.getElementById('totalJantaMarmitex').textContent = totals[3];
            document.getElementById('totalJantaLocal').textContent = totals[4];
            document.getElementById('totalGelo').textContent = totals[5];
        }

        function showCalculationPreview() {
            calculateTotals();
            
            const totals = {
                cafe: parseInt(document.getElementById('totalCafe').textContent),
                almocoMarmitex: parseInt(document.getElementById('totalAlmocoMarmitex').textContent),
                almocoLocal: parseInt(document.getElementById('totalAlmocoLocal').textContent),
                jantaMarmitex: parseInt(document.getElementById('totalJantaMarmitex').textContent),
                jantaLocal: parseInt(document.getElementById('totalJantaLocal').textContent),
                gelo: parseInt(document.getElementById('totalGelo').textContent)
            };

            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';

            let totalAmount = 0;

            const items = [
                { label: 'CAF√â', quantity: totals.cafe, price: prices.cafe },
                { label: 'ALMO√áO MARMITEX', quantity: totals.almocoMarmitex, price: prices.almocoMarmitex },
                { label: 'ALMO√áO LOCAL', quantity: totals.almocoLocal, price: prices.almocoLocal },
                { label: 'JANTA MARMITEX', quantity: totals.jantaMarmitex, price: prices.jantaMarmitex },
                { label: 'JANTA LOCAL', quantity: totals.jantaLocal, price: prices.jantaLocal },
                { label: 'GELO', quantity: totals.gelo, price: prices.gelo }
            ];

            items.forEach(item => {
                const itemTotal = item.quantity * item.price;
                totalAmount += itemTotal;

                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <div class="label">${item.label}</div>
                    <div class="quantity">${item.quantity} unidades</div>
                    <div class="value">${formatCurrency(itemTotal)}</div>
                `;
                previewGrid.appendChild(previewItem);
            });

            document.getElementById('previewTotalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('calculationModal').style.display = 'block';
        }

        function closeCalculationModal() {
            document.getElementById('calculationModal').style.display = 'none';
        }

        function proceedToSummary() {
            closeCalculationModal();
            generateSummary();
        }

        function updateStep(stepNumber) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < stepNumber) {
                    step.className = 'step completed';
                } else if (i === stepNumber) {
                    step.className = 'step active';
                } else {
                    step.className = 'step pending';
                }
            }
        }

        function generateSummary() {
            calculateTotals();
            updateStep(2);
            
            const totals = {
                cafe: parseInt(document.getElementById('totalCafe').textContent),
                almocoMarmitex: parseInt(document.getElementById('totalAlmocoMarmitex').textContent),
                almocoLocal: parseInt(document.getElementById('totalAlmocoLocal').textContent),
                jantaMarmitex: parseInt(document.getElementById('totalJantaMarmitex').textContent),
                jantaLocal: parseInt(document.getElementById('totalJantaLocal').textContent),
                gelo: parseInt(document.getElementById('totalGelo').textContent)
            };

            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';

            let totalAmount = 0;

            const items = [
                { label: 'CAF√â', quantity: totals.cafe, price: prices.cafe },
                { label: 'ALMO√áO MARMITEX', quantity: totals.almocoMarmitex, price: prices.almocoMarmitex },
                { label: 'ALMO√áO LOCAL', quantity: totals.almocoLocal, price: prices.almocoLocal },
                { label: 'JANTA MARMITEX', quantity: totals.jantaMarmitex, price: prices.jantaMarmitex },
                { label: 'JANTA LOCAL', quantity: totals.jantaLocal, price: prices.jantaLocal },
                { label: 'GELO', quantity: totals.gelo, price: prices.gelo }
            ];

            items.forEach(item => {
                const itemTotal = item.quantity * item.price;
                totalAmount += itemTotal;

                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <div class="label">${item.label}</div>
                    <div class="value">${item.quantity} unidades</div>
                    <div class="value">${formatCurrency(itemTotal)}</div>
                `;
                summaryGrid.appendChild(summaryItem);
            });

            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('summary').style.display = 'block';
            
            // Smooth scroll to summary
            document.getElementById('summary').scrollIntoView({ behavior: 'smooth' });
        }

        function getCurrentSupplier() {
            return currentSupplier;
        }

        function cleanCNPJ(cnpj) {
            // Remove all non-numeric characters from CNPJ
            return cnpj ? cnpj.replace(/\D/g, '') : '';
        }

        async function saveOrderToDatabase() {
            try {
                // Get form data
                const selectedSupplier = getCurrentSupplier();
                const month = document.getElementById('monthSelect').value;
                const quinzena = document.getElementById('quinzenaSelect').value;

                if (!selectedSupplier) {
                    throw new Error('Nenhum fornecedor selecionado');
                }

                if (!month || !quinzena) {
                    throw new Error('Per√≠odo (m√™s/quinzena) n√£o selecionado');
                }

                // Clean CNPJ (remove formatting)
                const cleanedCNPJ = cleanCNPJ(selectedSupplier.cpf_cnpj);

                // Generate dates for the period
                const currentDatesTemp = generateDatesForPeriod(month, quinzena);
                
                // Get all inputs from the table
                const inputs = document.querySelectorAll('#mealsTable tbody tr:not(.total-row) input');
                
                const savedOrders = [];
                
                // Process each day (row) individually
                for (let dayIndex = 0; dayIndex < currentDatesTemp.length; dayIndex++) {
                    const dateStr = currentDatesTemp[dayIndex]; // Format: DD/MM
                    const day = dateStr.split('/')[0];
                    const mealDate = `2025-${month}-${day}`; // Convert to YYYY-MM-DD
                    
                    // Get quantities for this specific day (row)
                    const rowStartIndex = dayIndex * 6; // 6 columns per row
                    const cafe = parseInt(inputs[rowStartIndex]?.value) || 0;
                    const almocoMarmitex = parseInt(inputs[rowStartIndex + 1]?.value) || 0;
                    const almocoLocal = parseInt(inputs[rowStartIndex + 2]?.value) || 0;
                    const jantaMarmitex = parseInt(inputs[rowStartIndex + 3]?.value) || 0;
                    const jantaLocal = parseInt(inputs[rowStartIndex + 4]?.value) || 0;
                    const gelo = parseInt(inputs[rowStartIndex + 5]?.value) || 0;
                    
                    // Prepare order data for this specific day
                    const orderData = {
                        data_refeicao: mealDate,
                        cnpj: cleanedCNPJ,
                        fornecedor: selectedSupplier.fornecedor,
                        cafe: cafe,
                        almoco_marmitex: almocoMarmitex,
                        almoco_local: almocoLocal,
                        janta_marmitex: jantaMarmitex,
                        janta_local: jantaLocal,
                        gelo: gelo,
                        valor_cafe: selectedSupplier.prices.cafe || 0,
                        valor_almoco_marmitex: selectedSupplier.prices.almocoMarmitex || 0,
                        valor_almoco_local: selectedSupplier.prices.almocoLocal || 0,
                        valor_janta_marmitex: selectedSupplier.prices.jantaMarmitex || 0,
                        valor_janta_local: selectedSupplier.prices.jantaLocal || 0,
                        valor_gelo: selectedSupplier.prices.gelo || 0
                    };

                    // Send to server
                    const response = await fetch('/api/save-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro do servidor para ${dateStr}: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    savedOrders.push({ date: dateStr, id: result.id });
                }
                
                // Show success message to user
                showCustomAlert(
                    '‚úÖ Todos os Pedidos Salvos!',
                    `${savedOrders.length} pedidos salvos com sucesso no banco de dados!<br>Datas: ${savedOrders.map(o => o.date).join(', ')}`,
                    () => {}
                );
                
                return savedOrders;

            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                throw error;
            }
        }

        async function startValidation() {
            const validationBtn = document.getElementById('validationBtn');
            const originalText = validationBtn.innerHTML;
            
            // Show loading state
            validationBtn.innerHTML = '‚è≥ Salvando dados...';
            validationBtn.disabled = true;
            validationBtn.style.opacity = '0.7';
            validationBtn.style.cursor = 'not-allowed';
            
            try {
                // First, save the order to database
                await saveOrderToDatabase();
                
                // Update button for facial validation
                validationBtn.innerHTML = 'üì∏ Preparando valida√ß√£o...';
                
            } catch (error) {
                // Reset button state
                validationBtn.innerHTML = originalText;
                validationBtn.disabled = false;
                validationBtn.style.opacity = '1';
                validationBtn.style.cursor = 'pointer';
                
                // If saving fails, ask user if they want to continue
                const continueAnyway = confirm('Erro ao salvar pedido no banco de dados. Deseja continuar mesmo assim com a valida√ß√£o facial?\n\nErro: ' + error.message);
                if (!continueAnyway) {
                    return; // Stop validation process
                }
                
                // If user wants to continue, show loading again
                validationBtn.innerHTML = 'üì∏ Preparando valida√ß√£o...';
                validationBtn.disabled = true;
                validationBtn.style.opacity = '0.7';
                validationBtn.style.cursor = 'not-allowed';
            }

            updateStep(3);
            document.getElementById('validationSection').style.display = 'block';
            
            // Update signature date/time
            const now = new Date();
            const dateTime = now.toLocaleString('pt-BR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('signatureDateTime').textContent = dateTime;
            
            // Reset button after validation section is shown
            setTimeout(() => {
                validationBtn.innerHTML = '‚úÖ Valida√ß√£o Iniciada';
                validationBtn.style.background = '#27ae60';
                validationBtn.style.opacity = '1';
                validationBtn.style.cursor = 'default';
            }, 500);
            
            // Smooth scroll to validation
            document.getElementById('validationSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function activateCamera() {
            // If this is QR capture mode, use camera directly
            if (isQRCaptureMode) {
                await startDirectCamera();
                return;
            }

            // Check device type and camera availability
            const isMobile = isMobileDevice();
            const hasCamera = await isCameraAvailable();

            if (isMobile || hasCamera) {
                // Use camera directly
                await startDirectCamera();
            } else {
                // Show QR Code for mobile capture
                await showQRCodeInterface();
            }
        }

        async function startDirectCamera() {
            try {
                // Clear any existing intervals and reset flags
                clearInterval(detectionInterval);
                clearInterval(countdownInterval);
                captureCountdown = 0;
                isCapturing = false;
                
                // Stop existing stream if any
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Request camera with specific constraints for mobile
                const constraints = {
                    video: { 
                        width: { ideal: 250, max: 250 },
                        height: { ideal: 250, max: 250 },
                        facingMode: 'user',
                        aspectRatio: 1.0
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('video');
                const placeholder = document.getElementById('cameraPlaceholder');
                const approachText = document.getElementById('approachText');
                const capturedImage = document.getElementById('capturedImage');
                const cameraFrame = document.querySelector('.camera-frame');
                
                // Reset camera frame styling
                cameraFrame.style.border = '5px solid #fff';
                cameraFrame.style.boxShadow = 'none';
                cameraFrame.classList.remove('face-detected');
                
                // Configure video element
                video.srcObject = stream;
                video.setAttribute('playsinline', 'true'); // Prevents fullscreen on iOS
                video.setAttribute('webkit-playsinline', 'true'); // Safari compatibility
                video.muted = true; // Prevents audio feedback
                video.style.display = 'block';
                video.style.transform = 'scaleX(-1)'; // Mirror effect for selfie
                
                placeholder.style.display = 'none';
                capturedImage.style.display = 'none';
                approachText.style.display = 'block';
                approachText.innerHTML = 'üîç Detectando rosto... Posicione-se na frente da c√¢mera';
                
                document.getElementById('activateCamera').style.display = 'none';
                document.getElementById('generatePdfBtn').style.display = 'none';
                
                // Start automatic face detection
                startFaceDetection(video);
                
            } catch (error) {
                showCustomAlert(
                    '‚ùå Erro na C√¢mera',
                    'Erro ao acessar a c√¢mera.<br>Verifique as permiss√µes.',
                    () => {} // onOk - do nothing
                );
                console.error('Erro na c√¢mera:', error);
            }
        }

        let detectionInterval;
        let countdownInterval;
        let captureCountdown = 0;
        let isCapturing = false; // Flag to prevent multiple captures

        function startFaceDetection(video) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const approachText = document.getElementById('approachText');
            const cameraFrame = document.querySelector('.camera-frame');
            
            canvas.width = 250;
            canvas.height = 250;
            
            detectionInterval = setInterval(() => {
                // Stop detection if already capturing
                if (isCapturing) {
                    clearInterval(detectionInterval);
                    return;
                }
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    context.drawImage(video, 0, 0, 250, 250);
                    
                    // Basic face detection based on image analysis
                    const imageData = context.getImageData(0, 0, 250, 250);
                    const pixels = imageData.data;
                    
                    // Calculate brightness and contrast
                    let totalBrightness = 0;
                    let skinTonePixels = 0;
                    
                    for (let i = 0; i < pixels.length; i += 4) {
                        const r = pixels[i];
                        const g = pixels[i + 1];
                        const b = pixels[i + 2];
                        
                        totalBrightness += (r + g + b) / 3;
                        
                        // Simple skin tone detection
                        if (r > 90 && g > 60 && b > 40 && r > b && r > g * 0.8) {
                            skinTonePixels++;
                        }
                    }
                    
                    const averageBrightness = totalBrightness / (pixels.length / 4);
                    const skinPercentage = (skinTonePixels / (pixels.length / 4)) * 100;
                    
                    // Face detected if good brightness and skin tones present
                    if (averageBrightness > 30 && skinPercentage > 3 && averageBrightness < 220) {
                        // Add green glow to camera frame
                        cameraFrame.classList.add('face-detected');
                        
                        // Face detected! Start countdown
                        if (captureCountdown === 0 && !isCapturing) {
                            startCaptureCountdown();
                        }
                    } else {
                        // Remove green glow
                        cameraFrame.classList.remove('face-detected');
                        
                        // No face detected, reset countdown
                        if (captureCountdown > 0 && !isCapturing) {
                            clearInterval(countdownInterval);
                            captureCountdown = 0;
                            approachText.innerHTML = 'üîç Detectando rosto... Posicione-se na frente da c√¢mera';
                            // Reset camera frame color
                            document.querySelector('.camera-frame').style.border = '5px solid #fff';
                            document.querySelector('.camera-frame').style.boxShadow = 'none';
                        }
                    }
                }
            }, 200);
        }

        function startCaptureCountdown() {
            // Prevent multiple countdowns
            if (isCapturing || captureCountdown > 0) {
                return;
            }
            
            const approachText = document.getElementById('approachText');
            const cameraFrame = document.querySelector('.camera-frame');
            
            captureCountdown = 3;
            isCapturing = true;
            
            // Make camera frame green
            cameraFrame.style.border = '5px solid #27ae60';
            cameraFrame.style.boxShadow = '0 0 20px rgba(39, 174, 96, 0.5)';
            
            countdownInterval = setInterval(() => {
                if (captureCountdown > 0) {
                    approachText.innerHTML = `‚úÖ Rosto detectado! Capturando em ${captureCountdown}...`;
                    captureCountdown--;
                } else {
                    clearInterval(countdownInterval);
                    clearInterval(detectionInterval);
                    autoCapture();
                }
            }, 1000);
        }

        function autoCapture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');
            const context = canvas.getContext('2d');
            const approachText = document.getElementById('approachText');
            const cameraFrame = document.querySelector('.camera-frame');
            
            // Clear all intervals to stop detection
            clearInterval(detectionInterval);
            clearInterval(countdownInterval);
            
            canvas.width = 250;
            canvas.height = 250;
            
            // Draw the current video frame to canvas
            context.drawImage(video, 0, 0, 250, 250);
            
            // Get the image data
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.8);
            
            // If this is QR capture mode, save to server and close
            if (isQRCaptureMode && currentSession) {
                // Send photo to server
                fetch(`/api/photo/${currentSession}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        photo: capturedPhoto
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Show success message and close
                    showCustomAlert(
                        '‚úÖ Foto Capturada!',
                        'Sua selfie foi enviada com sucesso!<br><br>Voc√™ pode fechar esta aba e retornar ao sistema principal.',
                        () => {
                            window.close(); // Try to close the tab
                        }
                    );
                })
                .catch(error => {
                    console.error('Error sending photo to server:', error);
                    showCustomAlert(
                        '‚ùå Erro',
                        'Erro ao enviar foto. Tente novamente.',
                        () => {}
                    );
                });
                return;
            }
            
            // Stop the camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Hide video and show captured photo as image
            video.style.display = 'none';
            canvas.style.display = 'none';
            capturedImage.src = capturedPhoto;
            capturedImage.style.display = 'block';
            
            // Keep green border and add success styling
            cameraFrame.style.border = '5px solid #27ae60';
            cameraFrame.style.boxShadow = '0 0 30px rgba(39, 174, 96, 0.8)';
            cameraFrame.classList.add('face-detected');
            
            document.getElementById('generatePdfBtn').style.display = 'inline-block';
            approachText.innerHTML = '‚úÖ Foto capturada e validada! Clique em "Gerar PDF" para finalizar';
            
            // Reset flags and counters
            captureCountdown = 0;
            isCapturing = false;
            
            // Add signature timestamp
            const now = new Date();
            document.getElementById('signatureDateTime').textContent = now.toLocaleString('pt-BR');
            
            // Auto-close camera view after 3 seconds on mobile
            if (window.innerWidth <= 768 && !isQRCaptureMode) {
                setTimeout(() => {
                    // Scroll to PDF button for better UX on mobile
                    document.getElementById('generatePdfBtn').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 2000);
            }
        }

        // Function to convert image to base64
        function getImageAsBase64(imageSrc, callback) {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = this.naturalWidth;
                canvas.height = this.naturalHeight;
                ctx.drawImage(this, 0, 0);
                const dataURL = canvas.toDataURL('image/png');
                callback(dataURL);
            };
            img.onerror = function() {
                callback(null);
            };
            img.src = imageSrc;
        }

        // QR Code Interface Functions
        async function showQRCodeInterface() {
            try {
                // Generate session ID and save
                currentSession = generateSessionId();
                saveSession(currentSession);

                // Hide camera container and show QR interface
                document.querySelector('.camera-container').style.display = 'none';
                document.getElementById('qrCodeInterface').style.display = 'block';

                // Generate QR Code URL
                const qrUrl = `${window.location.origin}${window.location.pathname}?mode=capture&session=${currentSession}`;
                const canvas = document.getElementById('qrCanvas');
                
                // Use ONLY external API - no JavaScript library
                const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrUrl)}`;
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 200;
                    ctx.drawImage(img, 0, 0, 200, 200);
                    // QR Code generated successfully
                };
                img.onerror = function() {
                    // Fallback: show only the link as text
                    const ctx = canvas.getContext('2d');
                    canvas.width = 300;
                    canvas.height = 120;
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, 300, 120);
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('QR Code indispon√≠vel', 150, 30);
                    ctx.font = '12px Arial';
                    ctx.fillText('Use o link manual abaixo', 150, 50);
                    // Fallback: show manual link
                };
                img.src = qrImageUrl;

                // Show manual link always
                document.getElementById('qrManualLink').textContent = qrUrl;
                
                // Start polling for photo
                startPhotoPolling();
                
            } catch (error) {
                console.error('Erro ao inicializar QR Code:', error);
                showCustomAlert(
                    'Erro QR Code',
                    'Use o link manual para acessar pelo celular.',
                    () => {}
                );
            }
        }

        function startPhotoPolling() {
            const statusEl = document.getElementById('qrStatus');
            statusEl.className = 'qr-status waiting';
            statusEl.innerHTML = '‚è≥ Aguardando captura no celular...';

            qrPollingInterval = setInterval(() => {
                // Check server for photo
                fetch(`/api/photo/${currentSession}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'found' && data.photo) {
                        clearInterval(qrPollingInterval);
                        capturedPhoto = data.photo;
                    
                        // Update status
                        statusEl.className = 'qr-status success';
                        statusEl.innerHTML = '‚úÖ Foto recebida com sucesso!';
                        
                        // Show captured photo and continue flow
                        const capturedImage = document.getElementById('capturedImage');
                        capturedImage.src = capturedPhoto;
                        capturedImage.style.display = 'block';
                        
                        // Hide QR interface and show PDF button
                        setTimeout(() => {
                            document.getElementById('qrCodeInterface').style.display = 'none';
                            document.querySelector('.camera-container').style.display = 'block';
                            document.getElementById('generatePdfBtn').style.display = 'inline-block';
                            
                            const approachText = document.getElementById('approachText');
                            approachText.style.display = 'block';
                            approachText.innerHTML = '‚úÖ Foto capturada via QR Code! Clique em "Gerar PDF" para finalizar';
                            
                            // Update signature timestamp
                            const now = new Date();
                            document.getElementById('signatureDateTime').textContent = now.toLocaleString('pt-BR');
                            
                            // Cleanup
                            cleanupSession(currentSession);
                        }, 2000);
                    } else {
                        // Photo not yet available, continue polling
                    }
                })
                .catch(error => {
                    console.error('Error polling for photo:', error);
                });
            }, 2000); // Check every 2 seconds

            // Set timeout for session (10 minutes)
            setTimeout(() => {
                if (qrPollingInterval) {
                    clearInterval(qrPollingInterval);
                    statusEl.className = 'qr-status';
                    statusEl.innerHTML = '‚è∞ Sess√£o expirada. Clique em "Ativar C√¢mera" para tentar novamente.';
                    cleanupSession(currentSession);
                }
            }, 10 * 60 * 1000);
        }

        function generatePDF() {
            // Show loading overlay
            showPDFLoading();
            
            updateStep(4);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get period info
            const month = document.getElementById('monthSelect').value;
            const quinzena = document.getElementById('quinzenaSelect').value;
            const monthName = monthNames[month];
            const startDate = currentDates[0];
            const endDate = currentDates[currentDates.length - 1];

            // Function to continue PDF generation after logo is loaded
            function continuePDFGeneration(logoBase64) {
                let y = 20; // Start position

                // Header with colors
                doc.setFillColor(44, 62, 80); // Dark blue
                doc.rect(0, 0, 210, 50, 'F');
                
                // Add LARSIL logo to PDF if available
                if (logoBase64) {
                    doc.addImage(logoBase64, 'PNG', 10, 5, 25, 15);
                }
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('SISTEMA DE FORNECIMENTO DE REFEI√á√ïES', 105, 18, { align: 'center' });
                
                doc.setFontSize(11);
                doc.text(`${quinzena}¬™ Quinzena de ${monthName}/2025`, 105, 28, { align: 'center' });
            
                // Supplier info
                if (currentSupplier) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Fornecedor: ${currentSupplier.fornecedor}`, 105, 38, { align: 'center' });
                    doc.text(`CNPJ: ${currentSupplier.cpf_cnpj}`, 105, 45, { align: 'center' });
                }            y = 60;

            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // Period info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Per√≠odo: ${startDate} √† ${endDate}`, 20, y);
            y += 15;

            // Table header
            doc.setFillColor(52, 152, 219); // Blue
            doc.rect(15, y - 5, 180, 8, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.setFont(undefined, 'bold');
            
            const headers = ['DATA', 'CAF√â', 'ALM. MARM.', 'ALM. LOCAL', 'JANTA M.', 'JANTA L.', 'GELO'];
            const colWidths = [28, 22, 24, 24, 24, 24, 24];
            let x = 15;
            
            headers.forEach((header, index) => {
                doc.text(header, x + colWidths[index]/2, y, { align: 'center' });
                x += colWidths[index];
            });

            y += 12;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            // Table data
            const inputs = document.querySelectorAll('#mealsTable tbody tr:not(.total-row) input');
            
            currentDates.forEach((date, dateIndex) => {
                // Check if we need a new page
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }
                
                // Alternate row colors
                if (dateIndex % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(15, y - 4, 180, 8, 'F');
                }
                
                x = 15;
                doc.setFontSize(7);
                
                // Date
                doc.text(date, x + colWidths[0]/2, y, { align: 'center' });
                x += colWidths[0];
                
                // Values for each meal type
                for (let col = 0; col < 6; col++) {
                    const inputIndex = dateIndex * 6 + col;
                    const value = inputs[inputIndex] ? (inputs[inputIndex].value || '0') : '0';
                    doc.text(value, x + colWidths[col + 1]/2, y, { align: 'center' });
                    x += colWidths[col + 1];
                }
                
                y += 8;
            });

            // Totals row
            y += 5;
            doc.setFillColor(39, 174, 96); // Green
            doc.rect(15, y - 4, 180, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            
            x = 15;
            doc.text('TOTAL', x + colWidths[0]/2, y, { align: 'center' });
            x += colWidths[0];
            
            const totalElements = ['totalCafe', 'totalAlmocoMarmitex', 'totalAlmocoLocal', 'totalJantaMarmitex', 'totalJantaLocal', 'totalGelo'];
            totalElements.forEach((elementId, index) => {
                const total = document.getElementById(elementId).textContent;
                doc.text(total, x + colWidths[index + 1]/2, y, { align: 'center' });
                x += colWidths[index + 1];
            });

            y += 20;
            doc.setTextColor(0, 0, 0);

            // Check if we need a new page for financial summary
            if (y > 200) {
                doc.addPage();
                y = 20;
            }

            // Financial summary
            doc.setFillColor(142, 68, 173); // Purple
            doc.rect(15, y - 5, 180, 8, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO FINANCEIRO', 105, y, { align: 'center' });
            
            y += 15;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');

            const totals = {
                cafe: parseInt(document.getElementById('totalCafe').textContent),
                almocoMarmitex: parseInt(document.getElementById('totalAlmocoMarmitex').textContent),
                almocoLocal: parseInt(document.getElementById('totalAlmocoLocal').textContent),
                jantaMarmitex: parseInt(document.getElementById('totalJantaMarmitex').textContent),
                jantaLocal: parseInt(document.getElementById('totalJantaLocal').textContent),
                gelo: parseInt(document.getElementById('totalGelo').textContent)
            };

            const items = [
                { label: 'CAF√â', quantity: totals.cafe, price: prices.cafe },
                { label: 'ALMO√áO MARMITEX', quantity: totals.almocoMarmitex, price: prices.almocoMarmitex },
                { label: 'ALMO√áO LOCAL', quantity: totals.almocoLocal, price: prices.almocoLocal },
                { label: 'JANTA MARMITEX', quantity: totals.jantaMarmitex, price: prices.jantaMarmitex },
                { label: 'JANTA LOCAL', quantity: totals.jantaLocal, price: prices.jantaLocal },
                { label: 'GELO', quantity: totals.gelo, price: prices.gelo }
            ];

            let totalAmount = 0;

            items.forEach(item => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                const itemTotal = item.quantity * item.price;
                totalAmount += itemTotal;
                doc.text(`${item.label}: ${item.quantity} un. x ${formatCurrency(item.price)} = ${formatCurrency(itemTotal)}`, 20, y);
                y += 10;
            });

            // Total highlighted
            y += 5;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFillColor(231, 76, 60); // Red
            doc.rect(15, y - 5, 180, 12, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL A RECEBER: ${formatCurrency(totalAmount)}`, 105, y, { align: 'center' });

            y += 20;
            doc.setTextColor(0, 0, 0);

            // Check if we need a new page for signature
            if (y > 200) {
                doc.addPage();
                y = 20;
            }

            // Signature section
            doc.setFillColor(52, 73, 94); // Dark gray
            doc.rect(15, y - 5, 180, 8, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('ASSINATURA DIGITAL', 105, y, { align: 'center' });
            
            y += 15;
            doc.setTextColor(0, 0, 0);

            // Add captured photo
            if (capturedPhoto) {
                doc.addImage(capturedPhoto, 'JPEG', 20, y, 25, 25);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                
                const signatureDateTime = document.getElementById('signatureDateTime').textContent;
                const signatureLocation = document.getElementById('signatureLocation').textContent;
                
                doc.text('Valida√ß√£o Facial:', 55, y + 5);
                doc.text(`Data/Hora: ${signatureDateTime}`, 55, y + 11);
                doc.text(`Local: ${signatureLocation}`, 55, y + 17);
                doc.setFont(undefined, 'bold');
                doc.text('‚úì Documento assinado digitalmente', 55, y + 23);
            }

            y += 35;

            // Check if we need a new page for footer
            if (y > 240) {
                doc.addPage();
                y = 20;
            }

            // Footer
            y += 15;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFillColor(236, 240, 241); // Light gray
            doc.rect(0, y - 5, 210, 15, 'F');
            
            doc.setFontSize(6);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(127, 140, 141);
            doc.text('Documento gerado automaticamente pelo Sistema de Fornecimento de Refei√ß√µes', 105, y, { align: 'center' });
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, y + 5, { align: 'center' });

            // Save PDF with supplier name
            const supplierNameSafe = currentSupplier.fornecedor.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_');
            const fileName = `${supplierNameSafe}-${monthName}-2025-${quinzena}Q.pdf`;
            
            // Check if mobile device for different download approach
            if (isMobileDevice()) {
                // Check if iOS for special handling
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    // iOS specific approach: open in new window
                    const pdfBase64 = doc.output('datauristring');
                    const newWindow = window.open();
                    newWindow.document.write(`
                        <html>
                            <head>
                                <title>PDF - ${fileName}</title>
                                <meta name="viewport" content="width=device-width, initial-scale=1">
                                <style>
                                    body { margin: 0; font-family: Arial, sans-serif; }
                                    .container { padding: 20px; text-align: center; }
                                    .download-btn { 
                                        background: #007bff; 
                                        color: white; 
                                        padding: 15px 30px; 
                                        border: none; 
                                        border-radius: 5px; 
                                        font-size: 16px;
                                        margin: 10px;
                                        cursor: pointer;
                                    }
                                    iframe { width: 100%; height: 80vh; border: none; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h2>üìÑ PDF Gerado com Sucesso!</h2>
                                    <p><strong>Arquivo:</strong> ${fileName}</p>
                                    <a href="${pdfBase64}" download="${fileName}" class="download-btn">
                                        üì• Baixar PDF
                                    </a>
                                    <button onclick="window.close()" class="download-btn" style="background: #6c757d;">
                                        ‚úñÔ∏è Fechar
                                    </button>
                                </div>
                                <iframe src="${pdfBase64}"></iframe>
                            </body>
                        </html>
                    `);
                    
                    // Hide loading for iOS after opening new window
                    setTimeout(() => {
                        hidePDFLoading();
                    }, 800);
                } else {
                    // Android and other mobile devices
                    const pdfBlob = doc.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    
                    // Create temporary download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = fileName;
                    downloadLink.style.display = 'none';
                    
                    // Add to DOM and trigger click
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
                
                // Show mobile-specific message
                setTimeout(() => {
                    showCustomAlert(
                        'üì± PDF Gerado!',
                        'O PDF foi baixado com sucesso!<br><br>üìÇ Verifique sua pasta de Downloads.<br><br>üí° Em alguns dispositivos m√≥veis, toque em "Baixar" ou verifique as notifica√ß√µes.',
                        () => {}
                    );
                    hidePDFLoading(); // Hide loading after alert
                }, 500);
            } else {
                // Desktop approach
                doc.save(fileName);
                
                // Hide loading for desktop
                setTimeout(() => {
                    hidePDFLoading();
                }, 300);
            }

            // Success message will be shown by the reset confirmation popup
        }

        // Load logo and generate PDF
        getImageAsBase64('LARSIL_branco_fundo_transparente.png', continuePDFGeneration);
    }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('calculationModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Initialize table on page load
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentPeriod();
            updatePeriod(); // Isso vai gerar as datas e a tabela
        });

        function setCurrentPeriod() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() returns 0-11
            const currentDay = currentDate.getDate();
            
            // Set current month
            document.getElementById('monthSelect').value = currentMonth.toString().padStart(2, '0');
            
            // Set current quinzena based on day
            let currentQuinzena = 1;
            if (currentDay > 15) {
                currentQuinzena = 2;
            }
            
            // If current quinzena already passed, move to next available period
            if (currentDay > 15 && currentQuinzena === 1) {
                currentQuinzena = 2;
            } else if (currentDay > 31) {
                // Move to next month, first quinzena
                const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
                document.getElementById('monthSelect').value = nextMonth.toString().padStart(2, '0');
                currentQuinzena = 1;
            }
            
            document.getElementById('quinzenaSelect').value = currentQuinzena.toString();
        }
        </script>
        </div> <!-- End mainSystem -->

        <script>
        // Function to initialize supplier select after data is loaded
        function initializeSupplierSelect() {
            // Clear any existing options first
            $('#supplierSelect').empty();
            $('#supplierSelect').append(new Option('Digite para buscar o fornecedor...', '', true, true));
            
            // Initialize Select2
            $('#supplierSelect').select2({
                placeholder: 'Digite para buscar o fornecedor...',
                allowClear: true,
                width: '100%'
            });

            // Populate suppliers in select2
            suppliers.forEach(function(supplier, index) {
                const option = new Option(supplier.fornecedor, index, false, false);
                $('#supplierSelect').append(option);
            });
            
            // Refresh Select2 after adding options
            $('#supplierSelect').trigger('change.select2');
        }

        // Initialize suppliers data and login functionality
        $(document).ready(function() {
            // Load suppliers from SQL Server Azure API
            loadSuppliersFromAPI();

            // Update supplier info when selection changes
            $('#supplierSelect').on('change', function() {
                const selectedIndex = this.value;
                const loginBtn = document.getElementById('loginBtn');
                const passwordField = document.getElementById('supplierPassword');
                
                if (selectedIndex !== '' && suppliers[selectedIndex]) {
                    passwordField.disabled = false;
                    passwordField.focus();
                    loginBtn.disabled = true;
                } else {
                    passwordField.disabled = true;
                    passwordField.value = '';
                    loginBtn.disabled = true;
                }
            });

            // Enable login button when password is entered
            document.getElementById('supplierPassword').addEventListener('input', function() {
                const loginBtn = document.getElementById('loginBtn');
                const selectedIndex = document.getElementById('supplierSelect').value;
                
                loginBtn.disabled = !(selectedIndex !== '' && this.value.length >= 4);
            });

            // Handle login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const selectedIndex = document.getElementById('supplierSelect').value;
                const enteredPassword = document.getElementById('supplierPassword').value;
                
                if (selectedIndex !== '' && suppliers[selectedIndex]) {
                    const supplier = suppliers[selectedIndex];
                    
                    // Extract first 4 digits from CNPJ
                    const cnpjDigits = supplier.cpf_cnpj.replace(/\D/g, ''); // Remove non-digits
                    const correctPassword = cnpjDigits.substring(0, 4);
                    
                    // Validate password
                    if (enteredPassword !== correctPassword) {
                        showCustomAlert(
                            '‚ùå Senha Incorreta!',
                            `Senha incorreta!<br><br>Use os 4 primeiros d√≠gitos do CNPJ: <strong>${correctPassword}</strong>`,
                            () => {
                                document.getElementById('supplierPassword').value = '';
                                document.getElementById('supplierPassword').focus();
                            }
                        );
                        return;
                    }
                    
                    currentSupplier = supplier;
                    
                    // Update welcome message
                    document.getElementById('welcomeMessage').innerHTML = `Bem-vindo, <strong>${currentSupplier.fornecedor}</strong> | CNPJ: ${currentSupplier.cpf_cnpj}`;
                    
                    // Update system prices
                    prices = currentSupplier.prices;
                    
                    // Hide login screen and show main system
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainSystem').style.display = 'block';
                    
                    // Initialize the system
                    updatePeriod();
                    
                    // Success message
                    setTimeout(() => {
                        showCustomAlert(
                            '‚úÖ Login Realizado!',
                            'Login realizado com sucesso!<br>Bem-vindo ao sistema.',
                            () => {} // onOk - do nothing
                        );
                    }, 500);
                }
            });
        });

        // Update prices based on selected supplier
        function updatePricesForSupplier(supplierKey) {
            const supplier = suppliers[supplierKey];
            if (supplier && supplier.prices) {
                // Update global prices object
                Object.assign(prices, supplier.prices);
                
                // If table already exists, regenerate it with new prices
                if (document.querySelector('#mealTable')) {
                    updatePeriod();
                }
            }
        }

        // Add reset functionality after PDF generation
        const originalGeneratePDF = window.generatePDF;
        window.generatePDF = function() {
            // Get period info before generating PDF
            const month = document.getElementById('monthSelect').value;
            const quinzena = document.getElementById('quinzenaSelect').value;
            const monthName = monthNames[month];
            const supplierNameSafe = currentSupplier.fornecedor.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_');
            const fileName = `${supplierNameSafe}-${monthName}-2025-${quinzena}Q.pdf`;
            
            originalGeneratePDF();
            
            // After PDF generation, offer to reset
            setTimeout(() => {
                showCustomConfirm(
                    'üîÑ PDF Gerado com Sucesso!',
                    `PDF gerado e salvo com sucesso!<br><br>üìÑ <strong>Arquivo:</strong> ${fileName}<br><br>Deseja resetar o formul√°rio para fazer um novo pedido?`,
                    () => resetFormForNewOrder(), // onYes
                    () => {} // onNo - do nothing
                );
            }, 2000);
        };

        // Function to reset form for new order while keeping login
        function resetFormForNewOrder() {
            // Store current supplier info in localStorage for auto-login after reload
            if (currentSupplier) {
                const supplierIndex = suppliers.findIndex(s => s.fornecedor === currentSupplier.fornecedor);
                const autoLoginData = {
                    supplierIndex: supplierIndex,
                    timestamp: Date.now()
                };
                localStorage.setItem('autoLogin', JSON.stringify(autoLoginData));
            }
            
            // Reload the page (this will reset everything)
            window.location.reload();
        }

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is QR capture mode first
            if (checkQRCaptureMode()) {
                return; // Don't continue with normal initialization
            }
            
            // Add login form event listener
            document.getElementById('loginForm').addEventListener('submit', login);
            
            // Load suppliers from API
            loadSuppliersFromAPI();
            
            // Initialize period to current month
            const currentDate = new Date();
            const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('monthSelect').value = currentMonth;
            
            // Set quinzena based on current date
            const currentDay = currentDate.getDate();
            if (currentDay <= 15) {
                document.getElementById('quinzenaSelect').value = '1';
            } else {
                document.getElementById('quinzenaSelect').value = '2';
            }
        });

        // PDF Loading Functions
        function showPDFLoading() {
            const overlay = document.getElementById('pdfLoadingOverlay');
            overlay.style.display = 'flex';
            
            // Reset progress
            updatePDFProgress(0, 'Iniciando gera√ß√£o do PDF...');
            
            // Simulate progress steps
            setTimeout(() => updatePDFProgress(20, 'Coletando dados do pedido...'), 200);
            setTimeout(() => updatePDFProgress(40, 'Formatando layout do documento...'), 800);
            setTimeout(() => updatePDFProgress(60, 'Adicionando assinatura digital...'), 1400);
            setTimeout(() => updatePDFProgress(80, 'Aplicando formata√ß√£o final...'), 2000);
        }

        function updatePDFProgress(percentage, message) {
            const progressBar = document.querySelector('.pdf-loading-progress-bar');
            const messageEl = document.querySelector('.pdf-loading-message');
            
            progressBar.style.width = percentage + '%';
            messageEl.textContent = message;
            
            // Update steps
            const steps = document.querySelectorAll('.pdf-loading-step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                
                if (index < Math.floor(percentage / 25)) {
                    step.classList.add('completed');
                } else if (index === Math.floor(percentage / 25)) {
                    step.classList.add('active');
                }
            });
        }

        function hidePDFLoading() {
            const overlay = document.getElementById('pdfLoadingOverlay');
            
            // Complete progress
            updatePDFProgress(100, 'PDF gerado com sucesso!');
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 800);
        }
    </script>

    <!-- PDF Loading Overlay -->
    <div id="pdfLoadingOverlay" class="pdf-loading-overlay">
        <div class="pdf-loading-container">
            <div class="pdf-loading-spinner"></div>
            <div class="pdf-loading-title">üìÑ Gerando PDF</div>
            <div class="pdf-loading-message">Iniciando gera√ß√£o do PDF...</div>
            
            <div class="pdf-loading-progress">
                <div class="pdf-loading-progress-bar"></div>
            </div>
            
            <div class="pdf-loading-steps">
                <div class="pdf-loading-step">‚úì Coletando dados do pedido</div>
                <div class="pdf-loading-step">‚úì Formatando layout do documento</div>
                <div class="pdf-loading-step">‚úì Adicionando assinatura digital</div>
                <div class="pdf-loading-step">‚úì Finalizando documento</div>
            </div>
        </div>
    </div>
</body>
</html>
